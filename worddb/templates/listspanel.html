<!DOCTYPE html>

<html>
<head>

<meta http-equiv="content-type" content="text/ html;charset=utf-8" />
<title>Panel of Lists</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
<script src="/static/js/jquery-autoresize.js" type="text/javascript"></script>
<script src="/static/function.js" type="text/javascript"></script>

<style type="text/css">

@import url(/static/global.css);
@import url(/static/buttons.css);

</style>
</head>

<!-- BODY -->

<body>

	<h2>lists page</h2>
	
	<ul id="lists-wrapper">
	{% for list in lists %}
		<li class="list">
			<div class="tag" style="display: inline-block">
				<span class="list-label">{{ list.label }}</span>
				<input type="hidden" name="label" value="{{ list.label }}">
				<input type="hidden" name="description" value="{{ list.description }}">
				<input type="hidden" name="listid" value="{{ list.id }}">
			</div>
			<div class="auxiliar-tag edit-list">edit</div>
		</li>
	{% empty %}
		<div>no lists found :P</div>
	{% endfor %}
	</ul>

	<button class="green styled-button" onClick="make_add_list_box()">Add List</button>

	<footer>
		<a href="/account">account</a> | 
		<a href="/logout">logout</a> | 
		<a href="/about">about</a>
	</footer>

	<div id="blackout" style="display: none"></div>

<!-- ####SCRIPT#### -->

<script type="text/javascript">

$('.list .tag').click(function () { location.replace('/lists/'+$(this).find('input[name=label]').val()); })
$('.edit-list').click(function () { make_edit_list_box($(this).parent('.list')); })
$('.tag, .button, .auxiliar-tag').addClass('unselectable');

{% autoescape off %}
{% if flash_msg %}
	show_flash_message('{{ flash_msg.text|escape }}', { {{ flash_msg.css }} }, 8000);
{% endif %}
{% endautoescape %}

// 
// db access functions

function add_list_db(csrf_token) { // adds a list to the database based on Add-List Box
	var form = {};
	$(['label', 'description']).each(function (index, item) {
		form[item] = $("#edit-wrapper [data-field="+item+"] .edit-field-value").val();
	});
	form['csrfmiddlewaretoken'] = csrf_token;

	$.ajax({
		url: '/lists/api/add_list', 
		context: this,
		data: form,
		type: 'post',
		dataType: 'json',
		success: function (data, status) {
			if (data['success']) {
				show_flash_message(data['text']);	
				add_list_tag($.extend(form, {'listid': data['listid']}));
				remove_add_list_box();
			} else {
				show_flash_message(data['text'], {'background': "#F60018"});
			}
		},
		error: function (jqXHR, textStatus, errorThrown) {
			// wtf?
		} });
}

function update_list_db(csrf_token) { // updates the list in the database based on the Edit-List box
	var form = {};
	$(['label', 'description']).each(function (index, item) {
		form[item] = $("#edit-wrapper [data-field="+item+"] .edit-field-value").val();
	});
	form['listid'] = $("#edit-wrapper input[name=listid]").val();
	form['csrfmiddlewaretoken'] = csrf_token;

	$.ajax({
		url: '/lists/api/change_list', 
		context: this,
		data: form,
		dataType: 'json',
		type: 'post',
		success: function (data, status) {
			if (data['success']) {
				show_flash_message(data['text']);
				update_list_tag(form);
				remove_edit_list_box();
			} else {
				console.log(data);
				show_flash_message(data['text'], {'background': "#F60018"});
			}
		},
		error: function (obj, status) {
			// wtf?
			alert(12);
		} });
}

function remove_list_db(csrf_token) { // removes the list being edited at the Edit-List from the database
	var form = {};
	form['listid'] = $("#edit-wrapper input[name=listid]").val();
	form['csrfmiddlewaretoken'] = csrf_token;

	$.ajax({
		url: '/lists/api/remove_list',
		context: this, 
		data: form,
		type: 'post',
		dataType: 'json', 
		success: function (data, status) {
			if (data['success']) {
				show_flash_message(data['text']);
				remove_list_tag(form);
				remove_edit_word_box();
			} else {
				show_flash_message(data['text'], {'background': "#F60018"});
			}
		},
		error: function (obj, status) {
			// wtf?
		} });
}

//***********************************


function add_list_tag(form) { 	
	var list_tag_html = [
		'<li class="list">',
		'	<div class="tag" style="display: inline-block">',
		'		<span class="list-label unselectable">'+form['label']+'</span>',
		'		<input type="hidden" name="label" value="'+form['label']+'">',
		'		<input type="hidden" name="description" value="'+form['description']+'">',
		'		<input type="hidden" name="listid" value="'+form['listid']+'">',
		'	</div>',
		'	<div class="auxiliar-tag edit-list unselectable">edit</div>',
		'</li>',
		].join('');

	$(list_tag_html)
		.hide()
			.appendTo('ul#lists-wrapper')
				.fadeIn();
	
	// add click functions
	var p = $("li.list input[name=listid][value="+form['listid']+"]").parent();
	p.click(function () { location.replace('/lists/'+$(this).find('input[name=label]').val()); });
	p.parent().find('.edit-list').click(function () { make_edit_list_box($(this).parent('.list')); });
}

function update_list_tag(form) { // updates the original list tag in the lists panel with new edited content
	var p = $("li.list input[name=listid][value="+form['listid']+"]").parent();
	p.find('.list-label').html(form['label']);
	$(['label', 'description']).each(function (index, item) {
		p.find("input[name="+item+"]").val(form[item]);
	});
}

function remove_list_tag(form) { // removes the original word tag from the list page
	var o = $("li.list input[name=listid][value="+form['listid']+"]");
	o.parent().parent().fadeOut( function() { $(this).remove(); });
}

//************************************

function make_add_list_box() { 
	show_blackout();
	$(add_list_box_html).hide().appendTo('body').fadeIn();
	$('#edit-wrapper textarea').autoResize({'extraSpace': 10});
	$("#edit-wrapper [data-field=label] .edit-field-value").focus();
}

function remove_add_list_box() { 
	remove_edit_list_box();
}

function make_edit_list_box(list) {
	show_blackout();
	$(edit_word_box_html).hide().appendTo('body').fadeIn();

	$(['label', 'description']).each(function (index, item) {
		var value = $(list).find('input[name='+item+']').val();
		$("#edit-wrapper [data-field="+item+"] .edit-field-value").val(value);
	});
	
	var listid = $(list).find('input[name=listid]').val();
	$("#edit-wrapper input[name=listid]").val(listid);

	$("#edit-wrapper textarea").autoResize({'extraSpace':10});
	$("#edit-wrapper [data-field=label] .edit-field-value").focus();
}

function remove_edit_list_box() {
	$("#edit-wrapper").fadeOut('fast', function() {
		$("#edit-wrapper").remove();
		hide_blackout();
	});
}

var edit_word_box_html = ['<div id="edit-wrapper" class="styled-box">',

	'	<div title="close" class="close-button" onClick="remove_edit_list_box()"></div>',
	'   <h2 class="box-title">Edit a List:</h2>',
	'	<div class="edit-field" data-field="label">',
	'		<div class="edit-field-label">list name:</div>',
	'		<textarea class="edit-field-value"></textarea>',
	'	</div>',

	'	<div style="clear: both"></div>',
	'	<div class="edit-field" data-field="description">',
	'		<div class="edit-field-label">description:</div>',
	'		<textarea class="edit-field-value"></textarea>',
	'	</div>',

	'	<input type="hidden" name="listid" value="" />',
	'	<div style="clear: both"></div>',
	'	<div class="buttons">',
	'	<button class="edit-button button blue" id="save-button" onClick="update_list_db(\'{{csrf_token}}\')">Save</button>',
	'	<button class="edit-button button red" id="remove-button" onClick="remove_list_db(\'{{csrf_token}}\')">Remove</button>',
	'	</div>',

	'</div>'].join('');

var add_list_box_html = ['<div id="edit-wrapper" class="styled-box">',

	'	<div title="close" class="close-button" onClick="remove_add_list_box()"></div>',
	'   <div class="box-title">Add a List:</div>',

	'	<div class="edit-field" data-field="label">',
	'		<div class="edit-field-label">list name:</div>',
	'		<textarea class="edit-field-value"></textarea>',
	'	</div>',

	'	<div style="clear: both"></div>',
	'	<div class="edit-field" data-field="description">',
	'		<div class="edit-field-label">description:</div>',
	'		<textarea class="edit-field-value"></textarea>',
	'	</div>',

	'	<div style="clear: both"></div>',
	'	<div class="buttons">',
	'	<button class="edit-button button blue" id="add-button" onClick="add_list_db(\'{{csrf_token}}\')">Create List</button>',
	'	<button class="edit-button button red" id="cancel-button" onClick="remove_add_word_box()">Cancel</button>',
	'	</div>',
	'</div>'].join('');

</script>

</body>
</html>